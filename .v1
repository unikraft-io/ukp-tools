#!/bin/bash

METHOD=$1
URL=$2
JSON=$3

shift
shift
shift

if [ -z "$KRAFTCLOUD_ADDR" ]; then
     if [ -z "$KRAFTCLOUD_METRO" ]; then
          echo "Info: KRAFTCLOUD_ADDR and KRAFTCLOUD_METRO are empty. Using KRAFTCLOUD_ADDR=https://api.fra0.kraft.cloud."
          KRAFTCLOUD_ADDR=https://api.fra0.kraft.cloud
     else
          KRAFTCLOUD_ADDR=https://api.${KRAFTCLOUD_METRO}.kraft.cloud
     fi
fi

if [ -z "$KRAFTCLOUD_TOKEN" ]; then
     echo "Error: KRAFTCLOUD_TOKEN must be set to the user's API token"
     exit 1
fi

RESPONSE=$(curl -s -H Expect: \
                -X $METHOD \
                -H "Authorization: Bearer $KRAFTCLOUD_TOKEN" \
                -H "Content-Type: application/json" \
                "$KRAFTCLOUD_ADDR/v1/$URL" \
                -d "${JSON:+$JSON}")

if [ -n "$KRAFTCLOUD_PIPE_JQ" ]; then
     exec echo "$RESPONSE" | jq
else
     exec echo "$RESPONSE"
fi
